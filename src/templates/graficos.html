<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráficos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/normalize.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <link rel="stylesheet" href="../static/css/graficos.css"> <!--Css para ver como está no live server-->
</head>

<body>
    <header id="navbar">
        <p>CROWS</p>
        <nav>
            <a href="{{ url_for('home') }}">Sobre</a>
            <a href="{{ url_for('graficos') }}">Gráficos</a>
            <a href="#">Municípios</a>
            <a href="#">Contato</a>
            <a href="{{ url_for('feedback') }}">Feedback</a>
        </nav>
    </header>

    <main>
        <section class="filtro" id="filtro">
            <form action="{{ url_for('graficos') }}" method="POST">

                <h3 style="margin-top: 2%;">PERÍODO</h3>
                <div class="campo-data">
                    <label for="data_inicial">Data inicial: <span id="label_inicial"></span></label>
                    <input type="range" id="data_inicial" name="data_inicial" min="0" max="74" value="0">
                </div>
                
                <div class="campo-data">
                    <label for="data_final">Data final: <span id="label_final"></span></label>
                    <input type="range" id="data_final" name="data_final" min="0" max="74" value="74">
                </div>
                               
                <h3>TIPO DE ANÁLISE</h3>
                <input type="radio" id="tipo" name="exp-imp" value="exportacao">
                <label for="tipo">Exportação</label><br>
                <input type="radio" id="tipo" name="exp-imp" value="importacao">
                <label for="tipo">Importação</label><br>

                <h3>MÉTRICA</h3>
                <input type="radio" id="agregado" name="metrica">
                <label for="agregado">Valor Agregado</label><br>

                <input type="radio" id="fob" name="metrica">
                <label for="fob">Valor FOB</label><br>

                <input type="radio" id="liquido" name="metrica">
                <label for="liquido">Kg Líquido</label><br>


                <h3>Filtrar por:</h3>
                <input type="radio" id="cidades" name="filtro" value="municipios">
                <label for="cidades">Municípios SP</label><br>

                <input type="radio" id="regiao" name="filtro" value="microrregiao">
                <label for="regiao">Microrregião</label><br>

                <input type="radio" id="portes" name="filtro" value="portes">
                <label for="portes">Portes Semelhantes</label><br>

                <input type="radio" id="carga" name="filtro" value="carga">
                <label for="produto">Por carga</label><br>

                <div class="campo-input">
                    <select id="opcoes-select">
                        <option value="">Selecione uma opção</option>
                    </select>
                </div>

                <button type="submit">Gerar Gráficos</button>
            </form>
        </section>

        <section class="grafico">
            {% if mostrar_grafico %}
            <!-- <h2>Gráfico de Balança Comercial</h2> -->
             <div class="iframe-graficos">
                <iframe class="responsive-iframe" src="{{ url_for('grafico_primeiro') }}" frameborder="0"></iframe>
                <iframe class="responsive-iframe" src="{{ url_for('grafico_segundo') }}" frameborder="0" ></iframe>
             </div>
           
            {% endif %}

        </section>
        
        <footer>
            <nav id="link-footer">
                <a href="{{ url_for('home') }}">Sobre</a>
                <a href="{{ url_for('graficos') }}">Gráficos</a>
                <a href="#">Municípios</a>
                <a href="#">Contato</a>
            </nav>
            <h6>©2025 Crows</h6>
        </footer>
    </main>

    <script>
        // Cria lista de meses/anos entre 2019-01 e 2024-12 (72 meses)
        const meses = [];
        for (let ano = 2019; ano <= 2025; ano++) {
            for (let mes = 1; mes <= 12; mes++) {
                const mesFormatado = mes.toString().padStart(2, '0');
                meses.push(`${ano}-${mesFormatado}`);
            }
        }
    
        const dataInicialInput = document.getElementById('data_inicial');
        const dataFinalInput = document.getElementById('data_final');
        const labelInicial = document.getElementById('label_inicial');
        const labelFinal = document.getElementById('label_final');
    
        // Função para atualizar o texto visível com o mês/ano
        function atualizarLabel(input, label) {
            const index = parseInt(input.value, 10);
            label.textContent = meses[index];
        }
    
        // Eventos de mudança nos sliders
        dataInicialInput.addEventListener('input', () => {
            atualizarLabel(dataInicialInput, labelInicial);
        });
    
        dataFinalInput.addEventListener('input', () => {
            atualizarLabel(dataFinalInput, labelFinal);
        });
    
        // Atualiza os labels ao carregar a página
        atualizarLabel(dataInicialInput, labelInicial);
        atualizarLabel(dataFinalInput, labelFinal);
    </script>

    <script>
        document.getElementById('opcoes-select').style.display = 'none';
        const select = document.getElementById('opcoes-select');
        const radios = document.getElementsByName('filtro');
    
        // Função para carregar CSV
        async function carregarCSV(path) {
            const response = await fetch(path);
            const texto = await response.text();
            const linhas = texto.trim().split('\n').slice(1); // pula o cabeçalho

            // Usando uma expressão regular para dividir corretamente, tratando as aspas
            return linhas.map(linha => {
                return linha.split('","').map(celula => celula.replace(/"/g, ''));
            });
        }
    
        // Função para atualizar as opções do select
        async function atualizarSelect(valor) {
            select.innerHTML = '<option value="">Selecione uma opção</option>';
            let opcoes = [];
    
            // Caso o filtro selecionado seja "microrregiao"
            if (valor === 'microrregiao') {
                document.getElementById('opcoes-select').style.display = 'block';
                const linhas = [
                ["Araraquara"],
                ["Araçatuba"],
                ["Bauru"],
                ["Campinas"],
                ["Marília"],
                ["Presidente Prudente"],
                ["Ribeirão Preto"],
                ["São José do Rio Preto"],
                ["São Paulo"],
                ["São José dos Campos"]
                ];
                const regioes = linhas.map(l => l[0]);
                select.innerHTML = '<option value="">Selecione uma microrregião</option>'
                opcoes = regioes;
    
            // Caso o filtro seja "portes" ou "municipios"
            } else if (valor === 'portes') {
                document.getElementById('opcoes-select').style.display = 'block';
                const linhas = await carregarCSV('{{ url_for("static", filename="opcoes-csv/df_mun.csv") }}');
                const cidades = [...new Set(linhas.map(l => l[0]))].sort();
                opcoes = cidades;
                select.innerHTML = '<option value="">Selecione uma cidade</option>'
    
            // Caso o filtro seja "carga"
            } else if (valor === 'carga') {
                document.getElementById('opcoes-select').style.display = 'block';
                const linhas = await carregarCSV('{{ url_for("static", filename="opcoes-csv/df_sh4.csv") }}');
                const cargas = linhas.map(l => l[0].substring(0,30)+'...');
                select.innerHTML = '<option value="">Selecione uma carga</option>'
                opcoes = cargas;
            } else if (valor == 'municipios'){
                document.getElementById('opcoes-select').style.display = 'none';
            }
    
            // Adicionando as opções ao select
            opcoes.forEach(op => {
                const opt = document.createElement('option');
                opt.value = op;
                opt.textContent = op;
                select.appendChild(opt);
            });
        }
    
        // Adicionando evento nos rádios de filtro
        radios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                atualizarSelect(e.target.value);
            });
        });
    </script>
</body>

</html>