<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráficos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/normalize.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="../static/css/graficos.css"> <!--Css para ver como está no live server-->
</head>

<body>
    <header id="navbar">
        <p>CROWS</p>
        <nav>
            <a href="{{ url_for('home') }}">Sobre</a>
            <a href="{{ url_for('graficos') }}">Gráficos</a>
            <a href="#">Municípios</a>
            <a href="#">Contato</a>
        </nav>
    </header>

    <main>
        <section class="filtro" id="filtro">
            <form action="{{ url_for('graficos') }}" method="POST">
                <h2>Filtrar por:</h2>
                <label><input type="radio" name="filtro" value="microrregiao"> Microrregião</label>
                <label><input type="radio" name="filtro" value="municipios"> Municípios SP</label>
                <label><input type="radio" name="filtro" value="portes"> Portes Semelhantes</label>
                <label><input type="radio" name="filtro" value="carga"> Filtro por Carga</label>
              
                <div id="campo-input">
                    <select id="opcoes-select">
                        <option value="">Selecione uma opção</option>
                    </select>
                </div>

                <script>
                    const select = document.getElementById('opcoes-select');
                    const radios = document.getElementsByName('filtro');
                
                    // Função para carregar CSV
                    async function carregarCSV(path) {
                        const response = await fetch(path);
                        const texto = await response.text();
                        const linhas = texto.trim().split('\n').slice(1); // pula o header
                        return linhas.map(l => l.split(','));
                    }
                
                    // Função para atualizar as opções do select
                    async function atualizarSelect(valor) {
                        select.innerHTML = '<option value="">Selecione uma opção</option>';
                        let opcoes = [];
                
                        // Caso o filtro selecionado seja "microrregiao"
                        if (valor === 'microrregiao') {
                            const linhas = await carregarCSV('{{ url_for("static", filename="opcoes-csv/df_pais.csv") }}');
                            const regioes = [...new Set(linhas.map(l => l[0]))];
                            opcoes = regioes;
                
                        // Caso o filtro seja "portes" ou "municipios"
                        } else if (valor === 'portes') {
                            const linhas = await carregarCSV('{{ url_for("static", filename="opcoes-csv/df_mun.csv") }}');
                            const cidades = [...new Set(linhas.map(l => l[0]))].sort();
                            opcoes = cidades;
                
                        // Caso o filtro seja "carga"
                        } else if (valor === 'carga') {
                            const linhas = await carregarCSV('{{ url_for("static", filename="opcoes-csv/df_sh4.csv") }}');
                            opcoes = linhas.map(([sh4, produto]) => {
                                let limitado = produto.slice(0, 50) + '...';
                                return `${sh4} - ${limitado}`;
                            });
                        }
                
                        // Adicionando as opções ao select
                        opcoes.forEach(op => {
                            const opt = document.createElement('option');
                            opt.value = op;
                            opt.textContent = op;
                            select.appendChild(opt);
                        });
                    }
                
                    // Adicionando evento nos rádios de filtro
                    radios.forEach(radio => {
                        radio.addEventListener('change', (e) => {
                            atualizarSelect(e.target.value);
                        });
                    });
                </script>

                <button type="submit">Gerar Gráficos</button>
            </form>
        </section>

        <section class="grafico">
            {% if mostrar_grafico %}
            <div class="teste">
                <iframe class="responsive-iframe" src="{{ url_for('grafico_resultado') }}" frameborder="0"></iframe>
                <iframe class="responsive-iframe" src="{{ url_for('grafico_vlagregado_exp_resultado') }}" frameborder="0"></iframe>
                <iframe class="responsive-iframe" src="{{ url_for('grafico_vlagregado_imp_resultado') }}" frameborder="0"></iframe>
            </div>
            {% endif %}
        </section>
        
        <footer>
            <nav id="link-footer">
                <a href="{{ url_for('home') }}">Sobre</a>
                <a href="{{ url_for('graficos') }}">Gráficos</a>
                <a href="#">Municípios</a>
                <a href="#">Contato</a>
            </nav>
            <h6>©2025 Crows</h6>
        </footer>
    </main>

    <script>
        function mostrarCampo(filtro) {
            // Esconde todos os campos de input
            const campos = document.querySelectorAll('.campo-input');
            campos.forEach(campo => campo.style.display = 'none');

            // Exibe o campo correspondente
            const campoSelecionado = document.getElementById('campo-' + filtro);
            if (campoSelecionado) {
                campoSelecionado.style.display = 'block';
            }
        }
    </script>
</body>

</html>
